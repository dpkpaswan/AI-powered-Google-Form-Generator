# AI-powered Google Form Generator

Full-stack app (Node/Express backend + React/Vite frontend) where users sign in with Google and generate/manage Google Forms inside their own Google account (owned by the user and stored in the user’s Google Drive).

## Setup

1. Install deps:

```bash
npm install
```

2. Create `.env` from `.env.example`.

3. Supabase schema:
- Run the SQL in `supabase/schema.sql` in your Supabase SQL editor.

4. Google OAuth (user consent flow):

- In Google Cloud Console, create an **OAuth 2.0 Client ID** (Web application).
- Add Authorized redirect URI:
  - `http://localhost:3000/auth/google/callback`
- Enable APIs:
  - **Google Forms API**
  - **Google Drive API**
- Set required backend env vars:
  - `GOOGLE_OAUTH_CLIENT_ID`
  - `GOOGLE_OAUTH_CLIENT_SECRET`
  - `GOOGLE_OAUTH_REDIRECT_URI`

This project is designed around **user-consent OAuth** (forms are owned by the signed-in user). If you choose to use a **service account** for experiments, never commit the key JSON—use environment variables / secret management only.

### Security note (service account key exposure)

If you ever accidentally publish a service account key (like a `gen-lang-client-*.json` file):
- Treat it as compromised and **revoke/disable it immediately** in Google Cloud Console.
- **Rotate** the key (create a new one only if you still need it).
- Remove it from git history (not just the latest commit) before making the repo public again.

## Run

```bash
npm run dev
```

In another terminal:

```bash
cd FRONTEND
npm install
npm run start
```

## Hosting (Render)

This app uses httpOnly **cookie-based sessions**, so the simplest production setup is to serve the React frontend and the API from the **same origin**.

This repo supports a single Render Web Service deployment via Docker (see `Dockerfile` and `render.yaml`).

### Steps

1. Push this repo to GitHub.

2. Render Dashboard → **New** → **Blueprint** → select your repo.
  - Render will pick up `render.yaml` and create a Web Service.

3. In the created service, set Environment Variables (Render → Service → Environment):
  - `FRONTEND_APP_URL=https://<your-render-service-domain>`
  - `SESSION_JWT_SECRET=<32+ chars>`
  - `TOKENS_ENCRYPTION_KEY_BASE64=<base64 32 bytes>`
  - `OPENAI_API_KEY=...`
  - `OPENAI_MODEL=gpt-4.1-mini` (or your choice)
  - `GOOGLE_OAUTH_CLIENT_ID=...`
  - `GOOGLE_OAUTH_CLIENT_SECRET=...`
  - `GOOGLE_OAUTH_REDIRECT_URI=https://<your-render-service-domain>/auth/google/callback`
  - `SUPABASE_URL=...`
  - `SUPABASE_SERVICE_ROLE_KEY=...`

4. Supabase schema:
  - Run the SQL in `supabase/schema.sql` in your Supabase SQL editor.

5. Google OAuth:
  - In Google Cloud Console → OAuth Client → add Authorized redirect URI:
    - `https://<your-render-service-domain>/auth/google/callback`
  - Ensure **Google Forms API** and **Google Drive API** are enabled.

6. Deploy. After it’s live:
  - Open `https://<your-render-service-domain>`
  - Click “Sign in with Google”

### Notes

- If you host frontend and backend on different domains, browsers will block the session cookie (SameSite rules). The single-service setup avoids this.

## API

### GET /auth/google

Starts Google OAuth 2.0 user-consent flow.

Scopes used:
- `https://www.googleapis.com/auth/forms.body`
- `https://www.googleapis.com/auth/drive`

### GET /me

Returns current logged-in user (or null) based on the httpOnly session cookie.

### POST /generate-form

Creates a new Google Form owned by the logged-in user, then stores metadata in Supabase.

Body:
```json
{
  "prompt": "Create a feedback form for a new mobile app",
  "formType": "feedback",
  "audience": "students",
  "language": "english",
  "tone": "formal"
}
```

Response includes:
- `formId`
- `formUrl` (responder/view URL)
- `editUrl`
- `responderUrl`

### GET /forms

Lists forms previously generated by the logged-in user (from Supabase).

### GET /forms/:formId

Fetches the form structure from Google Forms API for editing in the website UI.

### PUT /forms/:formId

Edits a form via your website UI, then syncs changes to Google Forms using `forms.batchUpdate`.

## Notes

- OAuth secrets stay on the backend only.
- Refresh tokens are stored server-side (encrypted at rest via `TOKENS_ENCRYPTION_KEY_BASE64`).
- Forms are created/updated using Google Forms API under the logged-in user's account.
